<div class="trader-modal">
  <h2 mat-dialog-title class="dialog-title">{{ dialogTitle }}</h2>
  
  <form [formGroup]="traderForm" (ngSubmit)="onSubmit()">
    <mat-dialog-content class="dialog-content">
      <!-- Trader Type Selection - Simplified to be at the top -->
      <div class="trader-type-selection" *ngIf="isNewTrader">
        <mat-radio-group formControlName="type" class="trader-type-group">
          <mat-radio-button [value]="traderTypes.NPC">NPC</mat-radio-button>
          <mat-radio-button [value]="traderTypes.ATM">ATM</mat-radio-button>
          <mat-radio-button [value]="traderTypes.OBJECT">Object</mat-radio-button>
        </mat-radio-group>
        
        <!-- Type-specific hints -->
        <div class="info-box">
          <mat-icon class="info-icon">info</mat-icon>
          <div class="info-content">
            <p *ngIf="traderForm.get('type')?.value === traderTypes.ATM">
              ATMs have fixed ID (-2) and className
            </p>
            <p *ngIf="traderForm.get('type')?.value === traderTypes.NPC">
              NPCs can have loadouts and categories
            </p>
            <p *ngIf="traderForm.get('type')?.value === traderTypes.OBJECT">
              Objects can have categories but no loadouts
            </p>
          </div>
        </div>
      </div>

      <div class="form-grid">
        <!-- Trader ID (disabled, auto-generated) -->
        <mat-form-field appearance="outline">
          <mat-label>Trader ID</mat-label>
          <input matInput formControlName="npcId" type="number" [disabled]="true">
          <mat-hint *ngIf="traderForm.get('type')?.value !== traderTypes.ATM">Auto-generated ID</mat-hint>
          <mat-hint *ngIf="traderForm.get('type')?.value === traderTypes.ATM">Fixed ID for ATMs</mat-hint>
        </mat-form-field>
        
        <!-- Class Name -->
        <mat-form-field appearance="outline">
          <mat-label>Class Name</mat-label>
          <input matInput formControlName="className" placeholder="e.g., SurvivorM_Boris" required>
          <mat-error *ngIf="traderForm.get('className')?.hasError('required')">
            Class name is required
          </mat-error>
        </mat-form-field>
        
        <!-- Given Name -->
        <mat-form-field appearance="outline">
          <mat-label>Given Name</mat-label>
          <input matInput formControlName="givenName" placeholder="e.g., Weapons Trader" required>
          <mat-error *ngIf="traderForm.get('givenName')?.hasError('required')">
            Name is required
          </mat-error>
        </mat-form-field>
                
        <!-- Role -->
        <mat-form-field appearance="outline">
          <mat-label>Role</mat-label>
          <input matInput formControlName="role" placeholder="e.g., Weapons Specialist">
        </mat-form-field>
      </div>
      
      <!-- Position Section - Using Expansion Panel -->
      <mat-accordion class="custom-expansion-panel">
        <mat-expansion-panel expanded>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>place</mat-icon>
              Position
            </mat-panel-title>
            <mat-panel-description>
              Set the position of the trader on the map
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="coordinates-grid">
            <mat-form-field appearance="outline">
              <mat-label>X</mat-label>
              <input matInput formControlName="positionX" type="number" step="0.01" required>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Y</mat-label>
              <input matInput formControlName="positionY" type="number" step="0.01" required>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Z</mat-label>
              <input matInput formControlName="positionZ" type="number" step="0.01" required>
            </mat-form-field>
          </div>
        </mat-expansion-panel>
        
        <!-- Orientation Section - Using Expansion Panel -->
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>rotate_right</mat-icon>
              Orientation
            </mat-panel-title>
            <mat-panel-description>
              The direction the trader is facing
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="coordinates-grid">
            <mat-form-field appearance="outline">
              <mat-label>X</mat-label>
              <input matInput formControlName="orientationX" type="number" step="0.01" required>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Y</mat-label>
              <input matInput formControlName="orientationY" type="number" step="0.01" required>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Z</mat-label>
              <input matInput formControlName="orientationZ" type="number" step="0.01" required>
            </mat-form-field>
          </div>
        </mat-expansion-panel>
        
        <!-- Categories Section - Using Expansion Panel -->
        <mat-expansion-panel *ngIf="traderForm.get('type')?.value !== traderTypes.ATM">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>category</mat-icon>
              Categories
            </mat-panel-title>
            <mat-panel-description>
              Choose the categories of items the trader will trade
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="categories-panel-content">
            <!-- Warning about unknown categories -->
            <div *ngIf="unknownCategoryIds.length > 0" class="unknown-categories-warning">
              <mat-icon class="warning-icon">warning</mat-icon>
              <div class="warning-message">
                <p>This trader has {{ unknownCategoryIds.length }} unknown {{ unknownCategoryIds.length === 1 ? 'category' : 'categories' }} that {{ unknownCategoryIds.length === 1 ? 'does' : 'do' }} not exist in the Category Editor.</p>
                <p>These categories may not work correctly in-game.</p>
              </div>
            </div>
            
            <!-- No categories available message -->
            <div *ngIf="availableCategories.length === 0 && unknownCategoryIds.length === 0" class="empty-categories">
              <mat-icon class="empty-icon">warning</mat-icon>
              <p class="empty-message">No categories are available. Create categories in the Category Editor first.</p>
            </div>
            
            <!-- Categories list -->
            <div *ngIf="availableCategories.length > 0 || unknownCategoryIds.length > 0" class="categories-selection">
              <!-- Selected categories summary -->
              <div class="selected-summary">
                <span class="selected-count">{{ getSelectedCategoryIds().length }} {{ unknownCategoryIds.length > 0 ? 'total' : 'of ' + availableCategories.length }} selected</span>
                <span *ngIf="unknownCategoryIds.length > 0" class="unknown-count">(including {{ unknownCategoryIds.length }} unknown)</span>
              </div>
              
              <!-- List of categories with checkboxes - starting with unknown categories -->
              <div class="categories-list">
                <!-- Unknown categories -->
                <mat-checkbox 
                  *ngFor="let category of getUnknownCategoriesForDisplay()"
                  color="warn"
                  [checked]="isCategorySelected(category.categoryId)"
                  (change)="toggleCategory(category.categoryId)"
                  class="category-checkbox unknown-category"
                >
                  <div class="category-info">
                    <span class="category-id">{{ category.categoryId }}</span>
                    <mat-icon class="unknown-icon" matTooltip="This category does not exist in the Category Editor">help_outline</mat-icon>
                  </div>
                </mat-checkbox>
                
                <!-- Known categories -->
                <mat-checkbox 
                  color="primary"
                  *ngFor="let category of getSortedCategories()"
                  [checked]="isCategorySelected(category.categoryId)"
                  (change)="toggleCategory(category.categoryId)"
                  class="category-checkbox"
                  [ngClass]="{'selected-category': isCategorySelected(category.categoryId)}"
                >
                  <div class="category-info">
                    <span class="category-name">{{ category.categoryName }}</span>
                    <span class="category-id">{{ category.categoryId }}</span>
                  </div>
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
        
        <!-- Currencies Section - Using Expansion Panel -->
        <mat-expansion-panel *ngIf="traderForm.get('type')?.value !== traderTypes.ATM">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>payments</mat-icon>
              Currencies
            </mat-panel-title>
            <mat-panel-description>
              Choose the currencies the trader will accept
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="currencies-panel-content">
            <!-- Warning about unknown currencies -->
            <div *ngIf="unknownCurrencyNames.length > 0" class="unknown-currencies-warning">
              <mat-icon class="warning-icon">warning</mat-icon>
              <div class="warning-message">
                <p>This trader has {{ unknownCurrencyNames.length }} unknown {{ unknownCurrencyNames.length === 1 ? 'currency' : 'currencies' }} that {{ unknownCurrencyNames.length === 1 ? 'does' : 'do' }} not exist in the Currency Editor.</p>
                <p>These currencies may not work correctly in-game.</p>
              </div>
            </div>
            
            <!-- No currencies available message -->
            <div *ngIf="availableCurrencyTypes.length === 0 && unknownCurrencyNames.length === 0" class="empty-currencies">
              <mat-icon class="empty-icon">warning</mat-icon>
              <p class="empty-message">No currencies are available. Create currencies in the Currency Editor first.</p>
            </div>
            
            <!-- Currencies list -->
            <div *ngIf="availableCurrencyTypes.length > 0 || unknownCurrencyNames.length > 0" class="currencies-selection">
              <!-- Selected currencies summary -->
              <div class="selected-summary">
                <span class="selected-count">{{ getSelectedCurrencyNames().length }} {{ unknownCurrencyNames.length > 0 ? 'total' : 'of ' + availableCurrencyTypes.length }} selected</span>
                <span *ngIf="unknownCurrencyNames.length > 0" class="unknown-count">(including {{ unknownCurrencyNames.length }} unknown)</span>
              </div>
              
              <!-- List of currencies with checkboxes - starting with unknown currencies -->
              <div class="currencies-list">
                <!-- Unknown currencies -->
                <mat-checkbox 
                  *ngFor="let currency of getUnknownCurrenciesForDisplay()"
                  color="warn"
                  [checked]="isCurrencySelected(currency.currencyName)"
                  (change)="toggleCurrency(currency.currencyName)"
                  class="currency-checkbox unknown-currency"
                >
                  <div class="currency-info">
                    <span class="currency-name">{{ currency.currencyName }}</span>
                    <mat-icon class="unknown-icon" matTooltip="This currency does not exist in the Currency Editor">help_outline</mat-icon>
                  </div>
                </mat-checkbox>
                
                <!-- Known currencies -->
                <mat-checkbox 
                  color="primary"
                  *ngFor="let currency of getSortedCurrencyTypes()"
                  [checked]="isCurrencySelected(currency.currencyName)"
                  (change)="toggleCurrency(currency.currencyName)"
                  class="currency-checkbox"
                  [ngClass]="{'selected-currency': isCurrencySelected(currency.currencyName)}"
                >
                  <div class="currency-info">
                    <span class="currency-name">{{ currency.currencyName }}</span>
                    <span class="currency-count" *ngIf="currency.currencies">
                      ({{ currency.currencies.length }} currencies)
                    </span>
                  </div>
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
        
        <!-- Loadouts Section - Using Expansion Panel -->
        <mat-expansion-panel *ngIf="traderForm.get('type')?.value === traderTypes.NPC">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>inventory_2</mat-icon>
              Loadouts
            </mat-panel-title>
            <mat-panel-description>
              Choose the loadouts the trader will carry
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="loadouts-panel-content">
            <p class="panel-info-text">
              Loadouts can be configured after creating the trader.
            </p>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
      
    </mat-dialog-content>
    
    <mat-dialog-actions>
      <button type="button" mat-button (click)="onCancel()">Cancel</button>
      <button 
        mat-raised-button color="primary" 
        [disabled]="traderForm.invalid"
      >
        {{ isNewTrader ? 'Add' : 'Save' }}
      </button>
    </mat-dialog-actions>
  </form>
</div>
